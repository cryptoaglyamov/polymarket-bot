name: Run Polymarket Bot

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Test multiple Asia proxies
      run: |
        echo "=== ТЕСТ АЗИАТСКИХ ПРОКСИ ==="
        
        # Список прокси для тестирования
        PROXIES=(
          "165.154.243.51:3128"      # Сингапур
          "188.166.56.249:3128"      # Сингапур
          "134.209.105.155:3128"     # Сингапур
          "68.183.141.128:3128"      # Сингапур
          "139.162.78.109:3128"      # Япония
          "139.162.44.17:3128"        # Япония
        )
        
        for PROXY in "${PROXIES[@]}"; do
          echo ""
          echo "=================================="
          echo "Тестируем прокси: $PROXY"
          echo "=================================="
          
          # Проверка доступности порта
          echo "1. Проверка порта:"
          timeout 3 nc -zv ${PROXY/:/ } 2>&1 && echo "✅ Порт открыт" || echo "❌ Порт закрыт"
          
          # Проверка внешнего IP
          echo "2. Внешний IP через прокси:"
          IP=$(timeout 5 curl -x http://$PROXY -s https://api.ipify.org 2>/dev/null)
          if [ -n "$IP" ]; then
            echo "✅ IP: $IP"
          else
            echo "❌ Не удалось получить IP"
          fi
          
          # Проверка Polymarket
          echo "3. Подключение к Polymarket:"
          STATUS=$(timeout 5 curl -I -x http://$PROXY -s -o /dev/null -w "%{http_code}" https://clob.polymarket.com 2>/dev/null)
          if [ "$STATUS" = "200" ]; then
            echo "✅ Polymarket доступен (статус: $STATUS)"
          else
            echo "❌ Polymarket недоступен (статус: $STATUS)"
          fi
          
          echo ""
        done
        
    - name: Set up proxy environment (если найден рабочий)
      if: false  # Пока отключаем, сначала нужно найти рабочий прокси
      run: |
        echo "HTTP_PROXY=http://WORKING_PROXY:PORT" >> $GITHUB_ENV
        echo "HTTPS_PROXY=http://WORKING_PROXY:PORT" >> $GITHUB_ENV
        echo "http_proxy=http://WORKING_PROXY:PORT" >> $GITHUB_ENV
        echo "https_proxy=http://WORKING_PROXY:PORT" >> $GITHUB_ENV
        echo "NO_PROXY=localhost,127.0.0.1" >> $GITHUB_ENV
        
    - name: Set up Python
      if: false
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      if: false
      run: |
        pip install -r requirements.txt
        
    - name: Run bot
      if: false
      env:
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: python bot.py
      
    - name: Save state file
      if: false
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add bot_state.json
        git diff --quiet && git diff --staged --quiet || git commit -m "Update bot state [skip ci]"
        git push

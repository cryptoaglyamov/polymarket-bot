name: Run Polymarket Bot

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Test multiple Asia proxies
      continue-on-error: true  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
      run: |
        echo "=== –¢–ï–°–¢ –ê–ó–ò–ê–¢–°–ö–ò–• –ü–†–û–ö–°–ò ==="
        
        # –°–ø–∏—Å–æ–∫ –ø—Ä–æ–∫—Å–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        PROXIES=(
          "165.154.243.51:3128"      # –°–∏–Ω–≥–∞–ø—É—Ä
          "188.166.56.249:3128"      # –°–∏–Ω–≥–∞–ø—É—Ä
          "134.209.105.155:3128"     # –°–∏–Ω–≥–∞–ø—É—Ä
          "68.183.141.128:3128"      # –°–∏–Ω–≥–∞–ø—É—Ä
          "139.162.78.109:3128"      # –Ø–ø–æ–Ω–∏—è
          "139.162.44.17:3128"       # –Ø–ø–æ–Ω–∏—è
          "128.199.156.164:3128"     # –°–∏–Ω–≥–∞–ø—É—Ä
          "165.22.73.186:3128"       # –°–∏–Ω–≥–∞–ø—É—Ä
          "167.71.43.241:3128"       # –°–∏–Ω–≥–∞–ø—É—Ä
          "139.59.103.81:3128"       # –°–∏–Ω–≥–∞–ø—É—Ä
          "68.183.94.177:3128"       # –°–∏–Ω–≥–∞–ø—É—Ä
          "167.71.239.153:3128"      # –°–∏–Ω–≥–∞–ø—É—Ä
          "139.162.190.165:3128"     # –Ø–ø–æ–Ω–∏—è
          "139.162.239.142:3128"     # –Ø–ø–æ–Ω–∏—è
        )
        
        WORKING_PROXY=""
        
        for PROXY in "${PROXIES[@]}"; do
          echo ""
          echo "=================================="
          echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∫—Å–∏: $PROXY"
          echo "=================================="
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ IP —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (—Ç–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥)
          IP=$(timeout 5 curl -x http://$PROXY -s https://api.ipify.org 2>/dev/null)
          if [ -n "$IP" ]; then
            echo "‚úÖ IP —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: $IP"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ Polymarket
            STATUS=$(timeout 5 curl -I -x http://$PROXY -s -o /dev/null -w "%{http_code}" https://clob.polymarket.com 2>/dev/null)
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Polymarket –¥–æ—Å—Ç—É–ø–µ–Ω (—Å—Ç–∞—Ç—É—Å: $STATUS)"
              WORKING_PROXY="$PROXY"
              echo "üéØ –ù–ê–ô–î–ï–ù –†–ê–ë–û–ß–ò–ô –ü–†–û–ö–°–ò: $PROXY"
              break
            else
              echo "‚ùå Polymarket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—Å—Ç–∞—Ç—É—Å: $STATUS)"
            fi
          else
            echo "‚ùå –ü—Ä–æ–∫—Å–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          fi
        done
        
        if [ -n "$WORKING_PROXY" ]; then
          echo "WORKING_PROXY=$WORKING_PROXY" >> $GITHUB_ENV
          echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–∫—Å–∏: $WORKING_PROXY"
        else
          echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û –†–ê–ë–û–ß–ò–• –ü–†–û–ö–°–ò"
        fi
        
    - name: Set up proxy environment
      if: env.WORKING_PROXY != ''
      run: |
        echo "HTTP_PROXY=http://${{ env.WORKING_PROXY }}" >> $GITHUB_ENV
        echo "HTTPS_PROXY=http://${{ env.WORKING_PROXY }}" >> $GITHUB_ENV
        echo "http_proxy=http://${{ env.WORKING_PROXY }}" >> $GITHUB_ENV
        echo "https_proxy=http://${{ env.WORKING_PROXY }}" >> $GITHUB_ENV
        echo "NO_PROXY=localhost,127.0.0.1" >> $GITHUB_ENV
        echo "‚úÖ –ü—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ${{ env.WORKING_PROXY }}"
        
    - name: Set up Python
      if: env.WORKING_PROXY != ''
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      if: env.WORKING_PROXY != ''
      run: |
        pip install -r requirements.txt
        
    - name: Run bot
      if: env.WORKING_PROXY != ''
      env:
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: python bot.py
      
    - name: Save state file
      if: env.WORKING_PROXY != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add bot_state.json
        git diff --quiet && git diff --staged --quiet || git commit -m "Update bot state [skip ci]"
        git push
        
    - name: No proxy found
      if: env.WORKING_PROXY == ''
      run: |
        echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û –†–ê–ë–û–ß–ò–• –ü–†–û–ö–°–ò"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–≤–æ–π VPS"
